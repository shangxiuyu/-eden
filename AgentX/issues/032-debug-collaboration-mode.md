# Issue 032: Debug 协作模式

## 概述

定义 AI 助手与开发者在 Debug 任务中的协作流程，确保：

1. 问题被系统性分析
2. 方案经过批准后再执行
3. 修改可追溯、可回滚

## 协作流程

```
┌─────────────────────────────────────────────────────────────┐
│                    Debug 协作流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 问题描述 (User)                                          │
│     ↓                                                       │
│  2. 调查分析 (AI)                                            │
│     - 收集日志、代码、数据                                    │
│     - 追踪调用链                                             │
│     - 定位根因                                               │
│     ↓                                                       │
│  3. 报告根因 (AI → User)                                     │
│     - 问题是什么                                             │
│     - 为什么发生                                             │
│     - 影响范围                                               │
│     ↓                                                       │
│  4. 提出方案 (AI → User)                                     │
│     - 修复方案（可能多个）                                    │
│     - 每个方案的优缺点                                        │
│     - 推荐方案及理由                                          │
│     ↓                                                       │
│  5. 批准方案 (User)                                          │
│     - 用户选择/修改方案                                       │
│     - 明确批准后才能执行                                      │
│     ↓                                                       │
│  6. 执行修复 (AI)                                            │
│     - 按批准的方案修改代码                                    │
│     - 每个修改点说明                                          │
│     ↓                                                       │
│  7. 验证测试 (User + AI)                                     │
│     - 运行测试                                               │
│     - 确认问题已解决                                          │
│     - 确认没有引入新问题                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 各阶段详细说明

### 阶段 1: 问题描述

**用户提供：**

- 问题现象
- 复现步骤（如果有）
- 相关日志/截图

### 阶段 2: 调查分析

**AI 执行：**

- 读取相关代码
- 分析数据流
- 追踪调用链
- 检查日志

**禁止：**

- ❌ 不允许修改任何代码
- ❌ 不允许执行可能有副作用的命令

### 阶段 3: 报告根因

**AI 输出格式：**

```markdown
## 问题分析报告

### 现象

[描述观察到的问题]

### 根因

[问题的根本原因]

### 调用链/数据流

[相关的代码路径]

### 影响范围

[哪些功能/模块受影响]
```

### 阶段 4: 提出方案

**AI 输出格式：**

```markdown
## 修复方案

### 方案 A: [名称]

- **修改点：** [文件:行号]
- **改动内容：** [描述]
- **优点：** [列出]
- **缺点：** [列出]

### 方案 B: [名称] (如果有)

...

### 推荐方案

[推荐哪个方案及理由]
```

### 阶段 5: 批准方案

**用户回复：**

- "批准方案 A" / "同意" / "执行"
- 或提出修改意见

**AI 必须等待明确批准才能继续**

### 阶段 6: 执行修复

**AI 执行：**

- 按批准方案修改代码
- 每个修改说明原因
- 使用 logger 而非 console

### 阶段 7: 验证测试

**执行：**

- typecheck
- build
- 运行相关测试
- 用户手动验证

## 关键规则

### AI 必须遵守

1. **未经批准不得修改代码**
   - 调查阶段只读不写
   - 方案提出后等待批准

2. **使用项目规范**
   - 日志用 `logger` 不用 `console`
   - 遵循项目代码风格

3. **报告要完整**
   - 根因要说清楚
   - 方案要有对比
   - 影响范围要明确

4. **修改要最小化**
   - 只改必要的部分
   - 不顺手重构
   - 不添加无关功能

### 用户责任

1. 提供清晰的问题描述
2. 及时给予批准/反馈
3. 参与最终验证

## 示例对话

```
User: 重启服务器后会话丢失了

AI: 让我调查一下...
    [读取代码、分析数据流]

    ## 问题分析报告
    ### 根因
    数据存储在内存中，没有持久化到磁盘...

    ## 修复方案
    ### 方案 A: 使用 SQLite
    ...

    等待你的批准。

User: 批准方案 A

AI: 好的，开始执行...
    [修改代码]

    修改完成，请运行 pnpm dev 测试。

User: [测试通过]

AI: 问题已解决！
```

## 适用场景

- Bug 修复
- 性能问题排查
- 数据问题调查
- 配置问题诊断

## 不适用场景

- 新功能开发（使用 031 协作模式）
- 大规模重构（需要单独计划）
- 紧急热修复（可简化流程）
