# Code Review Collaboration Mode

代码审查驱动的架构完善协作模式

---

## 协作模式

### 角色

- **Reviewer（Claude）**：挑剔地阅读源码，发现问题
- **Architect（用户）**：解答问题，给出方案

### 流程

```
1. Reviewer 读源码
        ↓
2. 发现问题（盲点/架构不清晰/功能不完整/坑）
        ↓
3. 提问，等待 Architect 解答
        ↓
4. Architect 解答
        ↓
5. Reviewer 确认理解，执行修复
        ↓
6. 回到 1，继续读下一块代码
```

---

## 原则

1. **问题驱动**：不是漫无目的读代码，是带着批判性思维找问题
2. **不轻易动手**：问题没完全清晰、方案没确定之前，不执行
3. **持续追问**：一个问题可以追问多轮，直到完全理解
4. **收敛机制**：通过设计好的 API 边界来收紧问题范围
5. **类型复用**：优先使用已定义的类型，不重复定义。检查 `@agentxjs/types` 包中是否已有所需类型

---

## 问题分类

| 分类           | 说明                             | 示例                                  |
| -------------- | -------------------------------- | ------------------------------------- |
| **盲点**       | 代码里缺失的逻辑，没想到的场景   | 错误处理缺失、边界条件未考虑          |
| **架构不清晰** | 职责模糊，依赖关系混乱，概念重叠 | 多个组件做同样的事、循环依赖          |
| **功能不完整** | 接口定义了但没实现，流程断裂     | 空方法、TODO 注释、未实现分支         |
| **坑**         | 潜在 bug，边界条件，并发问题     | 数组越界、null 未处理、race condition |

---

## 提问格式

```markdown
**问题 N：[简短标题]**

**代码位置**：`packages/xxx/src/yyy.ts:123`

**问题描述**：
[具体描述问题是什么]

**涉及的关键点**：

1. [第一个关键点]
2. [第二个关键点]
3. [第三个关键点]

**状态**：待解答
```

---

## 示例问题

### 问题 1：构造函数参数来源不明

**代码位置**：`packages/agent/src/AgentInstance.ts:124`

```typescript
constructor(
  definition: AgentDefinition,
  context: AgentContext,
  engine: AgentEngine,
  driver: AgentDriver,
  sandbox: Sandbox,
  bus: SystemBus  // ← 谁传入？
)
```

**问题描述**：
AgentInstance 构造函数需要 SystemBus，但谁来传入这个参数不清晰。

**涉及的关键点**：

1. 谁负责创建 AgentInstance？是 AgentX 层还是 Runtime 层？
2. 如果是 AgentX 层创建，它怎么拿到 Runtime 的 SystemBus？
3. 如果多个 Agent，它们共享一个 SystemBus 吗？

**状态**：待解答

---

### 问题 2：错误处理路径缺失

**代码位置**：`packages/runtime/src/RuntimeAgent.ts:256`

**问题描述**：
当 LLM API 调用失败时，没有看到 catch 逻辑，错误会如何传播？

**涉及的关键点**：

1. API 调用失败是 throw 还是返回 error 对象？
2. 错误是否需要通过 SystemBus 广播给监听者？
3. Session 里的消息状态是否需要标记为 failed？

**状态**：待解答

---

## 使用场景

| 场景             | 说明                       |
| ---------------- | -------------------------- |
| 新架构设计完成后 | 验证设计的完整性和一致性   |
| 重构后           | 检查是否有遗漏或引入新问题 |
| 团队知识传递     | 通过问答帮助新成员理解架构 |
| 发现设计盲点     | 系统性地找出未考虑的场景   |

---

## 收敛策略

当问题太多或太散时：

1. **按模块分组** - 先完成一个模块的所有问题
2. **按优先级排序** - 先解决核心流程的阻塞问题
3. **设定边界** - 只关注某一层的问题（如只看 Runtime 层）
4. **时间盒** - 限定每轮审查的时间

---

## 注意事项

1. **保持怀疑** - 即使代码能跑，也要问为什么这样设计
2. **别怕打断** - 发现问题立即提出，不要等到代码写完
3. **记录决策** - 重要的设计决策要写到注释或文档
4. **测试验证** - 问题修复后，确保有测试覆盖

---

## 退出条件

满足以下任一条件可结束审查：

- ✅ 所有发现的问题都已解答和修复
- ✅ 达到预定的代码覆盖范围
- ✅ 架构师确认可以结束
- ⏸️ 发现需要大规模重构，需要单独规划
