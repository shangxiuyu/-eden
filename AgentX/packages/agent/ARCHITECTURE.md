# AgentX Core Architecture

## Overview

AgentX Core provides the **stateful layer** on top of the stateless Engine. It manages Agent instances and Session persistence.

## Key Design: Stateless Driver + Context-based Config

```
┌─────────────────────────────────────────────────────────────────┐
│  Framework Layer                                                 │
├─────────────────────────────────────────────────────────────────┤
│  defineAgent()     - Composition tool                           │
│  ConfigSchema      - Type-safe config schema                    │
│                                                                  │
│  Config defined HERE (developer decides what config to have)    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ config
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Core Layer                                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  createAgent(definition, config)                                │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  AgentContext = Internal Fields + Config                 │    │
│  │                                                          │    │
│  │  {                                                       │    │
│  │    agentId: "agent_abc123",    // generated             │    │
│  │    createdAt: 1732617600000,   // generated             │    │
│  │    apiKey: "sk-xxx",           // from config           │    │
│  │    model: "claude-3",          // from config           │    │
│  │  }                                                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│       │                                                          │
│       │ context                                                  │
│       ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  AgentDriver.receive(message, context)                   │    │
│  │                                                          │    │
│  │  Driver is STATELESS - gets config from context          │    │
│  │  Same driver instance can serve multiple agents          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Core Interfaces

### AgentContext

Runtime context that merges internal fields with config:

```typescript
interface AgentContextBase {
  readonly agentId: string; // Generated by Core
  readonly createdAt: number; // Generated by Core
}

type AgentContext<TConfig> = AgentContextBase & Readonly<TConfig>;
```

### AgentDriver

Stateless driver interface:

```typescript
interface AgentDriver<TConfig = Record<string, unknown>> {
  readonly name: string;
  readonly description?: string;
  receive(message: UserMessage, context: AgentContext<TConfig>): AsyncIterable<StreamEventType>;
}
```

**Key Design**: Driver has NO internal state. All configuration comes from context.

### AgentPresenter

Output adapter interface:

```typescript
interface AgentPresenter {
  readonly name: string;
  readonly description?: string;
  present(agentId: string, output: AgentOutput): void | Promise<void>;
}
```

### AgentDefinition

Static agent definition:

```typescript
interface AgentDefinition<TConfig = Record<string, unknown>> {
  name: string;
  description?: string;
  driver: AgentDriver<TConfig>;
  presenters?: AgentPresenter[];
}
```

## Agent Lifecycle

```
createAgent(definition, config)
     │
     │ 1. createAgentContext(config)
     │ 2. new Agent(definition, context, engine)
     │ 3. container.register(agent)
     ▼
┌─────────────────────────────────────────────────────────────┐
│                      RUNNING                                 │
│                                                              │
│  agent.receive(message)                                      │
│       │                                                      │
│       ▼                                                      │
│  engine.receive(agentId, message)                           │
│       │                                                      │
│       ▼                                                      │
│  driver.receive(message, context) → events                  │
│       │                                                      │
│       ▼                                                      │
│  agent.notifyHandlers(event)                                │
└─────────────────────────────────────────────────────────────┘
     │
     │ destroy()
     ▼
┌─────────────────────────────────────────────────────────────┐
│                     DESTROYED                                │
│                                                              │
│  - Removed from AgentContainer                               │
│  - Cannot receive messages                                   │
│  - Event handlers cleared                                    │
└─────────────────────────────────────────────────────────────┘
```

## Event Subscription

Type-based subscription with O(1) lookup:

```
typedHandlers: Map<EventType, Set<Handler>>
┌──────────────────┬────────────────────────────────┐
│ "text_delta"     │ { handler1, handler2 }         │
│ "message_start"  │ { handler3 }                   │
│ "message_stop"   │ { handler3, handler4 }         │
└──────────────────┴────────────────────────────────┘

globalHandlers: Set<Handler>
{ handler5, handler6 }  // receive ALL events

notifyHandlers(event) {
  // 1. O(1) lookup for typed handlers
  typedHandlers.get(event.type)?.forEach(h => h(event))

  // 2. Global handlers
  globalHandlers.forEach(h => h(event))
}
```

## Session-Agent Relationship

Sessions and Agents have independent lifecycles:

```
┌───────────────────────┐     ┌───────────────────────┐
│  Session              │     │  Agent                │
│  - sessionId          │     │  - agentId            │
│  - title              │     │  - context            │
│  - messages[]         │     │  - lifecycle          │
│  - agentId? ──────────┼────→│                       │
└───────────────────────┘     └───────────────────────┘

Note: Agent destruction does NOT auto-delete session
      Session can be re-associated with new agent
```

## File Structure

```
packages/agentx-core/src/
├── agent/
│   ├── AgentContext.ts      # Context type + createAgentContext
│   ├── AgentDriver.ts       # Stateless driver interface
│   ├── AgentPresenter.ts    # Output adapter interface
│   ├── AgentDefinition.ts   # Static definition
│   ├── Agent.ts             # Runtime instance
│   ├── AgentContainer.ts    # Instance container
│   └── index.ts
├── session/
│   ├── Session.ts           # Session entity
│   ├── Message.ts           # Message entity
│   └── ...
├── context.ts               # Core context (singleton)
├── createAgent.ts           # Functional API
├── getAgent.ts              # Functional API
├── destroyAgent.ts          # Functional API
└── index.ts                 # Public exports
```
